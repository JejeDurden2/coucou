generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum Plan {
  FREE
  SOLO
  PRO
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
}

enum LLMProvider {
  CHATGPT
  CLAUDE
  MISTRAL
}

enum ScanJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  PARTIAL
  FAILED
}

enum ConsentType {
  TERMS_OF_SERVICE
  PRIVACY_POLICY
}

enum ConsentAction {
  ACCEPTED
  WITHDRAWN
}

enum AuditStatus {
  PENDING
  PAID
  CRAWLING
  ANALYZING
  COMPLETED
  FAILED
}

// ============================================
// MODELS
// ============================================

model User {
  id               String   @id @default(cuid())
  email            String   @unique
  name             String
  password         String?
  googleId         String?  @unique @map("google_id")
  avatarUrl        String?  @map("avatar_url")
  plan             Plan     @default(FREE)
  stripeCustomerId String?  @unique @map("stripe_customer_id")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Email notification fields
  lastInactivityEmailAt     DateTime? @map("last_inactivity_email_at")
  emailNotificationsEnabled Boolean   @default(true) @map("email_notifications_enabled")
  lastScanAt                DateTime? @map("last_scan_at")
  lastPostScanEmailAt       DateTime? @map("last_post_scan_email_at")
  lastUpgradeEmailAt        DateTime? @map("last_upgrade_email_at")
  lastWeeklyReportAt        DateTime? @map("last_weekly_report_at")
  lastPaymentFailedAt       DateTime? @map("last_payment_failed_at")
  previousPlan              Plan?     @map("previous_plan")
  subscriptionEndedAt       DateTime? @map("subscription_ended_at")

  projects            Project[]
  subscription        Subscription?
  passwordResetTokens PasswordResetToken[]
  consentLogs         ConsentLog[]
  auditOrders         AuditOrder[]

  @@index([lastUpgradeEmailAt])
  @@index([subscriptionEndedAt])
  @@index([previousPlan, subscriptionEndedAt])
  @@map("users")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")

  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique @map("user_id")
  stripeSubscriptionId String             @unique @map("stripe_subscription_id")
  status               SubscriptionStatus
  plan                 Plan
  currentPeriodStart   DateTime           @map("current_period_start")
  currentPeriodEnd     DateTime           @map("current_period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model Project {
  id            String    @id @default(cuid())
  userId        String    @map("user_id")
  name          String
  brandName     String    @map("brand_name")
  brandVariants String[]  @map("brand_variants")
  domain        String
  brandContext   Json?     @map("brand_context")
  lastScannedAt  DateTime? @map("last_scanned_at")
  lastAutoScanAt DateTime? @map("last_auto_scan_at")
  nextAutoScanAt DateTime? @map("next_auto_scan_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  prompts        Prompt[]
  scanJobs       ScanJob[]
  sentimentScans SentimentScan[]
  auditOrders    AuditOrder[]

  @@index([userId])
  @@map("projects")
}

model Prompt {
  id            String    @id @default(cuid())
  projectId     String    @map("project_id")
  content       String
  category      String?
  isActive      Boolean   @default(true) @map("is_active")
  lastScannedAt DateTime? @map("last_scanned_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  scans    Scan[]
  scanJobs ScanJob[]

  @@index([projectId])
  @@map("prompts")
}

model Scan {
  id         String      @id @default(cuid())
  promptId   String      @map("prompt_id")
  provider   LLMProvider
  executedAt DateTime    @default(now()) @map("executed_at")

  // Results for each LLM provider stored as JSON
  // Structure: { provider: LLMProvider, model: string, rawResponse: string,
  //              isCited: boolean, citationContext: string?, position: number?,
  //              competitors: string[], latencyMs: number }[]
  results Json

  createdAt DateTime @default(now()) @map("created_at")

  prompt Prompt @relation(fields: [promptId], references: [id], onDelete: Cascade)

  @@index([promptId, executedAt])
  @@index([provider])
  @@map("scans")
}

model ScanJob {
  id               String        @id @default(cuid())
  projectId        String        @map("project_id")
  userId           String        @map("user_id")
  promptId         String?       @map("prompt_id") // null = project scan, set = single prompt scan
  status           ScanJobStatus @default(PENDING)
  totalPrompts     Int           @map("total_prompts")
  processedPrompts Int           @default(0) @map("processed_prompts")
  successCount     Int           @default(0) @map("success_count")
  failureCount     Int           @default(0) @map("failure_count")
  errorMessage     String?       @map("error_message")
  startedAt        DateTime?     @map("started_at")
  completedAt      DateTime?     @map("completed_at")
  createdAt        DateTime      @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  prompt  Prompt? @relation(fields: [promptId], references: [id], onDelete: SetNull)

  @@index([projectId, createdAt])
  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([promptId])
  @@map("scan_jobs")
}

model ConsentLog {
  id        String        @id @default(cuid())
  userId    String        @map("user_id")
  type      ConsentType
  action    ConsentAction
  version   String
  ipAddress String?       @map("ip_address")
  userAgent String?       @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
  @@map("consent_logs")
}

model SentimentScan {
  id          String   @id @default(cuid())
  projectId   String   @map("project_id")
  scannedAt   DateTime @map("scanned_at")
  globalScore Int      @map("global_score")
  results     Json     // { gpt: { s, t, kp, kn }, claude: { s, t, kp, kn } } â€” Mistral not included (sentiment uses CLAUDE_OPUS only)

  createdAt DateTime @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, scannedAt])
  @@map("sentiment_scans")
}

model AuditOrder {
  id                    String      @id @default(cuid())
  userId                String      @map("user_id")
  projectId             String      @map("project_id")
  status                AuditStatus @default(PENDING)

  // Payment
  stripePaymentIntentId String?     @unique @map("stripe_payment_intent_id")
  amountCents           Int         @map("amount_cents")
  paidAt                DateTime?   @map("paid_at")

  // Brief
  briefPayload          Json        @map("brief_payload")

  // Twin
  twinAgentId           String?     @map("twin_agent_id")

  // PDF
  reportUrl             String?     @map("report_url")

  // Dashboard metadata (denormalized from analysis)
  geoScore                 Int?       @map("geo_score")
  verdict                  String?    @map("verdict")
  topFindings              String[]   @default([]) @map("top_findings")
  actionCountCritical      Int?       @map("action_count_critical")
  actionCountHigh          Int?       @map("action_count_high")
  actionCountMedium        Int?       @map("action_count_medium")
  totalActions             Int?       @map("total_actions")
  pagesAnalyzedClient      Int?       @map("pages_analyzed_client")
  pagesAnalyzedCompetitors Int?       @map("pages_analyzed_competitors")
  competitorsAnalyzed      String[]   @default([]) @map("competitors_analyzed")
  externalPresenceScore    Int?       @map("external_presence_score")

  // Raw data URLs (R2)
  crawlDataUrl             String?    @map("crawl_data_url")
  analysisDataUrl          String?    @map("analysis_data_url")

  // Retry & refund
  retryCount               Int        @default(0) @map("retry_count")
  refundedAt               DateTime?  @map("refunded_at")
  refundId                 String?    @map("refund_id")

  // Timing
  startedAt             DateTime?   @map("started_at")
  completedAt           DateTime?   @map("completed_at")
  failedAt              DateTime?   @map("failed_at")
  timeoutAt             DateTime?   @map("timeout_at")
  failureReason         String?     @map("failure_reason")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([projectId])
  @@map("audit_orders")
}
