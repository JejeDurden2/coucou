generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum Plan {
  FREE
  SOLO
  PRO
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
}

enum LLMProvider {
  OPENAI
  ANTHROPIC
}

// ============================================
// MODELS
// ============================================

model User {
  id               String   @id @default(cuid())
  email            String   @unique
  name             String
  password         String
  plan             Plan     @default(FREE)
  stripeCustomerId String?  @unique @map("stripe_customer_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  projects     Project[]
  subscription Subscription?

  @@map("users")
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique @map("user_id")
  stripeSubscriptionId String             @unique @map("stripe_subscription_id")
  status               SubscriptionStatus
  plan                 Plan
  currentPeriodStart   DateTime           @map("current_period_start")
  currentPeriodEnd     DateTime           @map("current_period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model Project {
  id            String    @id @default(cuid())
  userId        String    @map("user_id")
  name          String
  brandName     String    @map("brand_name")
  brandVariants String[]  @map("brand_variants")
  domain        String?
  lastScannedAt DateTime? @map("last_scanned_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  prompts Prompt[]

  @@index([userId])
  @@map("projects")
}

model Prompt {
  id        String  @id @default(cuid())
  projectId String  @map("project_id")
  content   String
  category  String?
  isActive  Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  scans   Scan[]

  @@index([projectId])
  @@map("prompts")
}

model Scan {
  id         String   @id @default(cuid())
  promptId   String   @map("prompt_id")
  executedAt DateTime @default(now()) @map("executed_at")

  // Results for each LLM provider stored as JSON
  // Structure: { provider: LLMProvider, model: string, rawResponse: string,
  //              isCited: boolean, citationContext: string?, position: number?,
  //              competitors: string[], latencyMs: number }[]
  results Json

  createdAt DateTime @default(now()) @map("created_at")

  prompt Prompt @relation(fields: [promptId], references: [id], onDelete: Cascade)

  @@index([promptId, executedAt])
  @@map("scans")
}
